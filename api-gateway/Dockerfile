#__Build
FROM mcr.microsoft.com/dotnet/sdk:6.0-alpine AS build
WORKDIR /src

ARG BASE_NUGET_SOURCE_INDEX_URI
ARG BASE_NUGET_SOURCE_NAME
ARG BASE_NUGET_SOURCE_USER_NAME
ARG BASE_NUGET_SOURCE_AUTH_TOKEN

ARG AUTHORIZATION_SERVICE_NUGET_SOURCE_INDEX_URI
ARG AUTHORIZATION_SERVICE_NUGET_SOURCE_NAME
ARG AUTHORIZATION_SERVICE_NUGET_SOURCE_USER_NAME
ARG AUTHORIZATION_SERVICE_NUGET_SOURCE_AUTH_TOKEN

COPY ["./src/BookStore.ApiGateway.sln", "./"]

COPY ["./src/BookStore.ApiGateway.Settings/*.csproj", "./BookStore.ApiGateway.Settings/"]
COPY ["./src/BookStore.ApiGateway.Configs/*.csproj", "./BookStore.ApiGateway.Configs/"]
COPY ["./src/BookStore.ApiGateway.AppEntryPoint/*.csproj", "./BookStore.ApiGateway.AppEntryPoint/"]

RUN dotnet nuget add source $BASE_NUGET_SOURCE_INDEX_URI --name $BASE_NUGET_SOURCE_NAME --username $BASE_NUGET_SOURCE_USER_NAME --password $BASE_NUGET_SOURCE_AUTH_TOKEN --store-password-in-clear-text
RUN dotnet nuget add source $AUTHORIZATION_SERVICE_NUGET_SOURCE_INDEX_URI --name $AUTHORIZATION_SERVICE_NUGET_SOURCE_NAME --username $AUTHORIZATION_SERVICE_NUGET_SOURCE_USER_NAME --password $AUTHORIZATION_SERVICE_NUGET_SOURCE_AUTH_TOKEN --store-password-in-clear-text

RUN dotnet restore /src/BookStore.ApiGateway.sln

COPY ["./src/.", "./"]
WORKDIR /src/BookStore.ApiGateway.AppEntryPoint
RUN dotnet publish -c release -o /published --no-restore

#__Release
FROM mcr.microsoft.com/dotnet/aspnet:6.0-alpine

ARG ENVIRONMENT

ARG BOOK_STORE_SWAGGER_UI_CLIENT_ID
ARG BOOK_STORE_SWAGGER_UI_CLIENT_SECRET

ARG AUTHORIZATION_SERVICE_URI
ARG BOOK_SERVICE_URI
ARG USER_SERVICE_URI
ARG ORDER_SERVICE_URI

ARG BOOK_STORE_EXTERNAL_URI

ENV ASPNETCORE_ENVIRONMENT=$ENVIRONMENT
ENV ASPNETCORE_URLS="http://+:80"

ENV APP_CONFIG__ENVIRONMENT=$ENVIRONMENT

ENV SWAGGER_UI_APPLICATION_CLIENT_CONFIG__CLIENT_ID=$BOOK_STORE_SWAGGER_UI_CLIENT_ID
ENV SWAGGER_UI_APPLICATION_CLIENT_CONFIG__CLIENT_SECRET=$BOOK_STORE_SWAGGER_UI_CLIENT_SECRET

ENV APP_CONFIG__EXTERNAL_URI=$BOOK_STORE_EXTERNAL_URI

ENV APP_CONFIG__AUTHORIZATION_SERVICE_URI=$AUTHORIZATION_SERVICE_URI
ENV APP_CONFIG__BOOK_SERVICE_URI=$BOOK_SERVICE_URI
ENV APP_CONFIG__USER_SERVICE_URI=$USER_SERVICE_URI
ENV APP_CONFIG__ORDER_SERVICE_URI=$ORDER_SERVICE_URI

ENV LOG_CONFIG__LOG_FILE_PATH="./logs/book-store.api-gateway.txt"
ENV LOG_CONFIG__OUTPUT_TEMPLATE="{Timestamp:yyyy-MM-dd HH:mm:ss} [{Level}] [{SourceContext:l}] {Message}{NewLine}{Exception}"


# ENV ASPNETCORE_ENVIRONMENT="Development"
# ENV ASPNETCORE_URLS="http://+:80"

# ENV SWAGGERUI_CLIENT_ID="SwaggerUI"
# ENV SWAGGERUI_CLIENT_SECRET="KmsleOF322(@4msl!!ols"
#___________________________
WORKDIR /BookStore.ApiGateway
COPY --from=build /published ./
ENTRYPOINT ["dotnet", "BookStore.ApiGateway.AppEntryPoint.dll"]